<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PickleBean Press — Pricing Calculator</title>
<style>
:root{
  --bg:#0f0f12; --panel:#15161a; --panel-2:#1c1e24;
  --text:#e9e9ef; --muted:#a1a7b1;
  --brand:#7a5cff; --accent:#b084ff;
  --ok:#30d158; --warn:#ff9f0a; --err:#ff453a;
  --r:14px; --shadow:0 8px 28px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:inherit}
header{position:sticky;top:0;background:linear-gradient(180deg,#111218,#0f0f1200);border-bottom:1px solid #1f2230;backdrop-filter:blur(6px);padding:14px 18px;z-index:2}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--accent));display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow);overflow:hidden}
.logo img{width:100%;height:100%;object-fit:cover;display:block}
.logo-fallback{display:grid;place-items:center;font-weight:800}
h1{margin:0;font-size:18px}
.sub{margin:2px 0 0;color:var(--muted);font-size:13px}
nav.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
nav.tabs button{padding:10px 14px;border-radius:10px;background:var(--panel);border:1px solid #242632;color:var(--text);cursor:pointer}
nav.tabs button.active{outline:2px solid var(--brand)}
main{max-width:1100px;margin:24px auto;padding:0 18px;min-height:60vh}
.panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #222636;border-radius:var(--r);padding:18px;box-shadow:var(--shadow);margin-bottom:16px}
.grid{display:grid;gap:14px}
.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:900px){.grid.cols-3{grid-template-columns:1fr 1fr}}
@media(max-width:680px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}
.field{display:flex;flex-direction:column;gap:8px}
label{font-size:13px;color:var(--muted)}
input,select,textarea{background:#0c0d11;border:1px solid #272b39;color:var(--text);border-radius:12px;padding:12px}
textarea{min-height:90px;resize:vertical}
button{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;background:var(--panel);color:var(--text);box-shadow:var(--shadow)}
button.primary{background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff}
button.ghost{background:#0c0d11;border:1px solid #272b39}
.kpi{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.kpi .chip{background:#0c0d11;border:1px solid #272b39;border-radius:999px;padding:8px 12px;font-size:13px;color:var(--muted)}
.price-lg{font-size:40px;font-weight:800;margin:0}
footer{border-top:1px solid #1f2230;padding:18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.hidden{display:none}
hr{border:0;border-top:1px solid #272b39;margin:16px 0}
small.muted{color:var(--muted)}
.footer-actions{display:flex;gap:10px;flex-wrap:wrap}

/* --- Print view --- */
#print-sheet { display:none; }
@media print {
  header, nav, footer, .tabs, .panel:not(#print-sheet) { display:none !important; }
  body { background:#fff; color:#000; }
  #print-sheet { display:block !important; padding:24px; max-width:900px; margin:0 auto; }
  #print-sheet header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  #print-sheet .logo{width:56px;height:56px;border-radius:10px;box-shadow:none}
  #print-sheet .company h1{margin:0;font-size:20px}
  #print-sheet .company .muted{color:#555}
  #print-sheet h2 { margin:18px 0 8px; font-size:16px; }
  #print-sheet .row { display:flex; gap:18px; flex-wrap:wrap; margin:8px 0; }
  #print-sheet .kvs div { margin:2px 0; }
  #print-sheet table { width:100%; border-collapse:collapse; margin-top:8px; }
  #print-sheet th, #print-sheet td { border:1px solid #ddd; padding:8px; text-align:left; }
  #print-sheet .totals { margin-top:14px; }
  #print-sheet .totals div { margin:2px 0; }
  #print-sheet .muted { color:#555; }
  #print-meta{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;border-top:1px solid #eee;margin-top:16px;padding-top:12px}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true" id="site-logo"><div class="logo-fallback">PB</div></div>
    <div>
      <h1 id="site-company">Pricing Calculator</h1>
      <p class="sub">Single-file — multi-category</p>
    </div>
  </div>
  <nav class="tabs" role="tablist" aria-label="Calculator sections">
    <button data-tab="home" class="active" role="tab">Home</button>
    <button data-tab="stickers" role="tab">Stickers</button>
    <button data-tab="apparel" role="tab">Apparel</button>
    <button data-tab="engraving" role="tab">Engraving</button>
    <button data-tab="homeware" role="tab">Homeware</button>
    <button data-tab="books" role="tab">Books</button>
    <button data-tab="listing" role="tab">Listing</button>
    <button data-tab="settings" role="tab" style="margin-left:auto">Settings</button>
    <button data-tab="qq" role="tab">Quick Quote</button>
  </nav>
</header>

<main>
  <section id="tab-home" class="panel">
    <h2>Welcome</h2>
    <p>This single-file calculator has full tabs for all categories. Use <b>Settings</b> to adjust fees/postage/margin, branding & contact details, quote validity & payment terms. Use <b>Quick Quote</b> for fast estimates.</p>
  </section>

  <section id="tab-stickers" class="panel hidden"></section>
  <section id="tab-apparel" class="panel hidden"></section>
  <section id="tab-engraving" class="panel hidden"></section>
  <section id="tab-homeware" class="panel hidden"></section>
  <section id="tab-books" class="panel hidden"></section>
  <section id="tab-listing" class="panel hidden"></section>

  <section id="tab-settings" class="panel hidden">
    <h2>Settings</h2>
    <div class="grid cols-3" id="settings-form"></div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="primary" id="save-settings">Save</button>
      <button id="clear-settings">Revert to defaults</button>
    </div>
    <p class="small muted">Settings save locally (per device) via localStorage.</p>
  </section>

  <section id="tab-qq" class="panel hidden">
    <h2>Quick Quote</h2>
    <div class="grid cols-3" id="qq-form"></div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="primary" id="qq-calc">Calculate</button>
      <button id="qq-clear">Clear</button>
    </div>
    <div class="panel" style="margin-top:16px">
      <h3>Estimate</h3>
      <p id="qq-total" class="price-lg">—</p>
      <div id="qq-breakdown" class="kpi"></div>
    </div>
  </section>
</main>

<footer>
  <div class="footer-actions">
    <button id="btn-copy" class="ghost">Copy Quote</button>
    <button id="btn-reset" class="ghost">Reset</button>
    <button id="btn-export" class="ghost">Export JSON</button>
    <button id="btn-email" class="ghost">Email Quote</button>
    <button id="btn-print" class="primary">Print / PDF</button>
  </div>
  <small>© <span id="year"></span> <span id="foot-company">PickleBean Press</span></small>
</footer>

<!-- Print-only container -->
<section id="print-sheet" aria-hidden="true" class="panel">
  <header>
    <div class="logo" id="pr-logo"></div>
    <div class="company">
      <h1 id="pr-company">PickleBean Press</h1>
      <div class="muted" id="pr-contact"></div>
    </div>
  </header>

  <div id="print-meta">
    <div><strong>Category:</strong> <span id="pr-category">—</span></div>
    <div><strong>Item:</strong> <span id="pr-item">—</span></div>
    <div><strong>Date:</strong> <span id="pr-date">—</span></div>
    <div><strong>Valid until:</strong> <span id="pr-valid">—</span></div>
  </div>

  <h2>Breakdown</h2>
  <table>
    <thead><tr><th>Line</th><th>Qty</th><th>Unit</th><th>Cost</th></tr></thead>
    <tbody id="pr-lines"></tbody>
  </table>

  <div class="totals">
    <div><strong>Subtotal:</strong> <span id="pr-sub">—</span></div>
    <div><strong>Platform Fees:</strong> <span id="pr-fees">—</span></div>
    <div><strong>Postage:</strong> <span id="pr-post">—</span></div>
    <div><strong>Margin:</strong> <span id="pr-mar">—</span></div>
    <div class="hidden" id="pr-flat-wrap"><strong>Machine/Tools:</strong> <span id="pr-flat">—</span></div>
    <div><strong>TOTAL:</strong> <span id="pr-total">—</span></div>
  </div>

  <h2>Notes</h2>
  <div id="pr-notes" class="muted">—</div>

  <h2>Payment terms</h2>
  <div id="pr-terms" class="muted">Payment due within 7 days.</div>

  <p class="muted" style="margin-top:18px">
    Generated by <span id="gen-company">PickleBean Press</span> — <span id="pr-generated"></span>
  </p>
</section>

<script>
/* ---------- Core utils & config ---------- */
const $=(s,r=document)=>r.querySelector(s);
const money=(n,c='GBP')=>new Intl.NumberFormat('en-GB',{style:'currency',currency:c}).format(n);
const store=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k)=>{try{return JSON.parse(localStorage.getItem(k))}catch{return null}};
const defaults={
  platform_pct:6.5,
  payment_fixed:0.20,
  postage_flat:0.87,
  margin_pct:50,
  currency:'GBP',
  cc_email:'',
  logo_url:'',
  company_name:'PickleBean Press',
  company_email:'',
  company_phone:'',
  company_address:'',
  quote_valid_days:14,
  payment_terms:'Payment due within 7 days.',
  // New from Sam:
  machine_tools_flat:1.00,
  default_packaging_per_unit:0.0685
};
let cfg=Object.assign({},defaults,load('pb_settings')||{});

const Calc={
  lines:[],
  reset(){this.lines=[]},
  add(label,qty,unit){this.lines.push({label,qty,unit,cost:qty*unit})},
  subtotal(){return this.lines.reduce((a,b)=>a+b.cost,0)}
};
function totals(){
  const s=Calc.subtotal();
  const fees=s*(cfg.platform_pct/100)+cfg.payment_fixed;
  const post=cfg.postage_flat;
  const margin=s*(cfg.margin_pct/100);
  const flat=Number(cfg.machine_tools_flat)||0;
  return {subtotal:s,fees,postage:post,margin,flat,grand:s+fees+post+margin+flat};
}

/* ---------- Tabs & actions ---------- */
document.querySelectorAll('nav.tabs button').forEach(b=>b.onclick=()=>{document.querySelectorAll('nav.tabs button').forEach(x=>x.classList.remove('active'));b.classList.add('active');Object.values(panels).forEach(p=>p.classList.add('hidden'));panels[b.dataset.tab].classList.remove('hidden');location.hash=b.dataset.tab; if(b.dataset.tab==='listing'){ buildListingIfNeeded(); refreshListingFromQuote(); }});
const panels={home:$('#tab-home'),stickers:$('#tab-stickers'),apparel:$('#tab-apparel'),engraving:$('#tab-engraving'),homeware:$('#tab-homeware'),books:$('#tab-books'),listing:$('#tab-listing'),settings:$('#tab-settings'),qq:$('#tab-qq')};
$('#year').textContent=new Date().getFullYear();

/* Header/company branding live fill */
function applyBranding(){
  const siteLogo=$('#site-logo'); siteLogo.innerHTML='';
  if (cfg.logo_url){
    const img=new Image(); img.src=cfg.logo_url; img.alt='Logo'; siteLogo.append(img);
  } else {
    const fb=document.createElement('div'); fb.className='logo-fallback'; fb.textContent='PB'; siteLogo.append(fb);
  }
  $('#site-company').textContent = cfg.company_name || 'Pricing Calculator';
  $('#foot-company').textContent = cfg.company_name || 'PickleBean Press';
}
applyBranding();

$('#btn-copy').onclick=()=>navigator.clipboard.writeText(JSON.stringify({cfg,last:window.lastQuote||{}},null,2)).then(()=>alert('Copied!'));
$('#btn-reset').onclick=()=>{localStorage.clear();location.reload()};
$('#btn-export').onclick=()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify({cfg,last:window.lastQuote||{}},null,2)],{type:'application/json'}));a.download='calculator-state.json';a.click()};

/* ---------- Email Quote (mailto) ---------- */
function activeTab(){
  const btn=[...document.querySelectorAll('nav.tabs button')].find(b=>b.classList.contains('active'));
  return btn?.dataset.tab || 'home';
}
function collectDescAndNotes(tab){
  const map={stickers:['desc-stk','notes-stk'],apparel:['desc-app','notes-app'],engraving:['desc-eng','notes-eng'],homeware:['desc-hw','notes-hw'],books:['desc-bk','notes-bk']};
  const [dId,nId]=map[tab]||[null,null];
  return {
    desc: dId ? (document.getElementById(dId)?.value || '') : (window.lastQuote?.description || ''),
    notes: nId ? (document.getElementById(nId)?.value || '') : ''
  };
}
function composeEmailBody(q){
  const cur=q.currency||cfg.currency;
  const lines = (q.lines||[]).map(L=>`• ${L.label}: ${L.qty} × ${money(L.unit,cur)} = ${money(L.cost,cur)}`).join('\n');
  const t = q.totals;
  const validUntil = formatDate(addDays(new Date(), cfg.quote_valid_days));
  const contact = [
    cfg.company_name,
    cfg.company_email,
    cfg.company_phone,
    cfg.company_address
  ].filter(Boolean).join(' | ');
  const parts = [
    contact ? `${contact}\n` : null,
    `Category: ${q.category||'—'}`,
    q.description ? `Item: ${q.description}` : null,
    '',
    'Breakdown:',
    lines || '• (no lines)',
    '',
    `Subtotal: ${money(t.subtotal, cur)}`,
    `Platform Fees: ${money(t.fees, cur)}`,
    `Postage: ${money(t.postage, cur)}`,
    `Margin: ${money(t.margin, cur)}`,
    t.flat ? `Machine/Tools: ${money(t.flat, cur)}` : null,
    `TOTAL: ${money(t.grand, cur)}`,
    '',
    q.notes ? `Notes: ${q.notes}` : null,
    `Valid until: ${validUntil}`,
    `Payment terms: ${cfg.payment_terms}`,
    `Generated: ${new Date().toLocaleString()}`
  ].filter(Boolean);
  return parts.join('\n');
}
$('#btn-email').onclick=()=>{
  const tab = activeTab();
  const {desc, notes} = collectDescAndNotes(tab);
  const fallback = {
    category: tab,
    description: desc,
    notes,
    currency: cfg.currency,
    lines: [],
    totals: { subtotal:0, fees:0, postage:cfg.postage_flat, margin:0, flat:Number(cfg.machine_tools_flat)||0, grand:cfg.postage_flat + (Number(cfg.machine_tools_flat)||0) }
  };
  const q = window.lastQuote ? { ...window.lastQuote } : fallback;
  if (desc) q.description = desc;
  if (notes) q.notes = notes;

  const client = prompt('Client email address? (To:)') || '';
  const cc = cfg.cc_email || '';
  const subject = `Quote — ${q.description || q.category || 'Item'}`;
  const body = composeEmailBody(q);
  const mailto = `mailto:${encodeURIComponent(client)}?${[
    cc ? `cc=${encodeURIComponent(cc)}` : '',
    `subject=${encodeURIComponent(subject)}`,
    `body=${encodeURIComponent(body)}`
  ].filter(Boolean).join('&')}`;
  window.location.href = mailto;
};

/* ---------- Print / PDF ---------- */
function addDays(d,days){ const nd=new Date(d); nd.setDate(nd.getDate()+days); return nd; }
function formatDate(d){ return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
function fillPrintSheet(q){
  const cur=q.currency||cfg.currency;
  const set=(id, val)=>document.getElementById(id).textContent = val;

  // logo
  const prLogo=$('#pr-logo'); prLogo.innerHTML=''; 
  if (cfg.logo_url){ const img=new Image(); img.src=cfg.logo_url; img.alt='Logo'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; prLogo.append(img); }
  // company block
  $('#pr-company').textContent = cfg.company_name || '—';
  const contactBits=[cfg.company_email,cfg.company_phone,cfg.company_address].filter(Boolean);
  $('#pr-contact').textContent = contactBits.join(' | ');
  $('#gen-company').textContent = cfg.company_name || '—';

  set('pr-category', q.category || activeTab());
  set('pr-item', q.description || '—');
  set('pr-date', new Date().toLocaleString());
  set('pr-sub', money(q.totals.subtotal, cur));
  set('pr-fees', money(q.totals.fees, cur));
  set('pr-post', money(q.totals.postage, cur));
  set('pr-mar',  money(q.totals.margin, cur));
  if (q.totals.flat){ $('#pr-flat').textContent = money(q.totals.flat,cur); $('#pr-flat-wrap').classList.remove('hidden'); }
  else { $('#pr-flat-wrap').classList.add('hidden'); }
  set('pr-total',money(q.totals.grand, cur));
  set('pr-generated', new Date().toLocaleString());
  set('pr-valid', formatDate(addDays(new Date(), Number(cfg.quote_valid_days)||14)));
  document.getElementById('pr-terms').textContent = cfg.payment_terms || '';
  document.getElementById('pr-notes').textContent = q.notes || '—';

  const tbody=document.getElementById('pr-lines'); tbody.innerHTML='';
  (q.lines||[]).forEach(L=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${L.label}</td><td>${L.qty}</td><td>${money(L.unit, cur)}</td><td>${money(L.cost, cur)}</td>`;
    tbody.append(tr);
  });
}
document.getElementById('btn-print').addEventListener('click', ()=>{
  const tab = activeTab();
  const {desc, notes} = collectDescAndNotes(tab);
  const fallback = {
    category: tab,
    description: desc,
    notes,
    currency: cfg.currency,
    lines: [],
    totals: { subtotal:0, fees:0, postage:cfg.postage_flat, margin:0, flat:Number(cfg.machine_tools_flat)||0, grand:cfg.postage_flat + (Number(cfg.machine_tools_flat)||0) }
  };
  const q = window.lastQuote ? { ...window.lastQuote } : fallback;
  if (desc) q.description = desc;
  if (notes) q.notes = notes;

  fillPrintSheet(q);
  window.print();
});

/* ---------- Settings ---------- */
const sf=$('#settings-form');
[
 ['Platform Fee %','platform_pct',cfg.platform_pct,'number'],
 ['Payment Fee (fixed)','payment_fixed',cfg.payment_fixed,'number'],
 ['Default Postage (flat)','postage_flat',cfg.postage_flat,'number'],
 ['Default Margin %','margin_pct',cfg.margin_pct,'number'],
 ['Currency','currency',cfg.currency,'select',['GBP','USD','EUR']],
 ['Your email for CC','cc_email',cfg.cc_email||'','text'],
 ['Logo URL','logo_url',cfg.logo_url||'','text'],
 ['Company name','company_name',cfg.company_name||'','text'],
 ['Company email','company_email',cfg.company_email||'','text'],
 ['Company phone','company_phone',cfg.company_phone||'','text'],
 ['Company address','company_address',cfg.company_address||'','textarea'],
 ['Quote valid for (days)','quote_valid_days',cfg.quote_valid_days||14,'number'],
 ['Payment terms','payment_terms',cfg.payment_terms||'Payment due within 7 days.','textarea'],
 ['Machine & tools flat fee (per quote)','machine_tools_flat',cfg.machine_tools_flat||0,'number'],
 ['Default packaging per unit','default_packaging_per_unit',cfg.default_packaging_per_unit||0,'number']
].forEach(([label,key,val,type,options])=>{
  const d=document.createElement('div');d.className='field';
  if(type==='select'){
    d.innerHTML=`<label>${label}</label><select data-key="${key}">${options.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
    d.querySelector('select').value=val;
  } else if (type==='textarea'){
    d.innerHTML=`<label>${label}</label><textarea data-key="${key}" placeholder="${label}">${val||''}</textarea>`;
  } else if (type==='number'){
    d.innerHTML=`<label>${label}</label><input type="number" step="0.01" value="${val}" data-key="${key}">";
  } else {
    d.innerHTML=`<label>${label}</label><input type="text" value="${val}" placeholder="${label}" data-key="${key}">`;
  }
  sf.append(d);
});
$('#save-settings').onclick=()=>{
  const out={};
  sf.querySelectorAll('input,select,textarea').forEach(el=>{
    const k=el.dataset.key;
    const raw=el.value;
    if (['currency','cc_email','logo_url','company_name','company_email','company_phone','company_address','payment_terms'].includes(k)) out[k]=raw;
    else out[k]=Number(raw);
  });
  cfg=Object.assign({}, cfg, out);
  store('pb_settings',out);
  applyBranding();
  alert('Saved'); location.reload();
};
$('#clear-settings').onclick=()=>{localStorage.removeItem('pb_settings'); location.reload()};

/* ---------- Quick Quote ---------- */
const qf=$('#qq-form');
(function buildQQ(){
  const rows=[
    ['Category','select',['Stickers','Apparel','Engraving','Homeware','Books','Other']],
    ['Description','text','e.g., 2× Instagram tag decals, white'],
    ['Quantity','number',2,0.01],
    ['Unit Material Cost (£)','number',0.35,0.01],
    ['Unit Labour Cost (£)','number',0.20,0.01],
    ['Target Margin %','number',cfg.margin_pct,1],
    ['Postage (flat)','number',cfg.postage_flat,0.01],
    ['Platform Fee %','number',cfg.platform_pct,0.1],
    ['Payment Fee (fixed)','number',cfg.payment_fixed,0.01],
    ['Currency','select',['GBP','USD','EUR']],
    ['Notes (optional)','text','Gift message, colour, deadline…'],
  ];
  rows.forEach(([label,type,val,step])=>{
    const d=document.createElement('div'); d.className='field'; d.innerHTML=`<label>${label}</label>`;
    if(type==='select'){
      const s=document.createElement('select'); (Array.isArray(val)?val:[val]).forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;s.append(o)}); if(label==='Currency') s.value=cfg.currency; d.append(s);
    }else if(type==='number'){
      const i=document.createElement('input'); i.type='number'; i.step=String(step||1); i.value=val; d.append(i);
    }else{ const i=document.createElement('input'); i.placeholder=val||''; d.append(i); }
    qf.append(d);
  });
})();
$('#qq-calc').onclick=()=>{
  const els=qf.querySelectorAll('input,select');
  const data={
    category:els[0].value, description:els[1].value, qty:+els[2].value||0,
    unitMat:+els[3].value||0, unitLab:+els[4].value||0,
    marginPct:+els[5].value||0, postage:+els[6].value||0,
    feePct:+els[7].value||0, feeFixed:+els[8].value||0,
    currency:els[9].value, notes:els[10].value||''
  };
  Calc.reset(); Calc.add('Materials',data.qty,data.unitMat); Calc.add('Labour',data.qty,data.unitLab);
  const s=Calc.subtotal(); const f=s*(data.feePct/100)+data.feeFixed; const p=data.postage; const m=s*(data.marginPct/100); const flat=cfg.machine_tools_flat||0; const g=s+f+p+m+flat;
  window.lastQuote={category:data.category, description:data.description, lines:Calc.lines, totals:{subtotal:s,fees:f,postage:p,margin:m,flat,grand:g}, currency:data.currency, notes:data.notes};
  $('#qq-total').textContent=money(g,data.currency);
  $('#qq-breakdown').innerHTML=`<div class="chip">Subtotal: ${money(s,data.currency)}</div><div class="chip">Platform Fees: ${money(f,data.currency)}</div><div class="chip">Postage: ${money(p,data.currency)}</div><div class="chip">Margin: ${money(m,data.currency)}</div>${flat?`<div class="chip">Machine/Tools: ${money(flat,data.currency)}</div>`:''}`;
};
$('#qq-clear').onclick=()=>{$('#qq-total').textContent='—';$('#qq-breakdown').innerHTML='';qf.querySelectorAll('input').forEach(i=>i.value='')};

/* ---------- Helpers ---------- */
function chip(label,val,c=cfg.currency){ const d=document.createElement('div'); d.className='chip'; d.textContent=`${label}: ${money(val,c)}`; return d; }
function resultPanel(root,idPrefix){
  const panel=document.createElement('div'); panel.className='panel'; panel.style.marginTop='16px';
  panel.innerHTML=`<h3>Totals</h3><p id="${idPrefix}-total" class="price-lg">—</p><div id="${idPrefix}-bk" class="kpi"></div><hr><div id="${idPrefix}-lines" class="kpi"></div>`;
  root.append(panel);
  return {
    set(t,lines,curr=cfg.currency){
      $('#'+idPrefix+'-total').textContent=money(t.grand,curr);
      const bk=$('#'+idPrefix+'-bk'); bk.innerHTML=''; bk.append(chip('Subtotal',t.subtotal,curr),chip('Platform Fees',t.fees,curr),chip('Postage',t.postage,curr),chip('Margin',t.margin,curr)); if (t.flat) bk.append(chip('Machine/Tools',t.flat,curr));
      const ln=$('#'+idPrefix+'-lines'); ln.innerHTML=''; lines.forEach(L=>ln.append(chip(`${L.label} (${L.qty} × ${money(L.unit,curr)})`, L.cost, curr)));
    },
    clear(){ $('#'+idPrefix+'-total').textContent='—'; $('#'+idPrefix+'-bk').innerHTML=''; $('#'+idPrefix+'-lines').innerHTML=''; }
  };
}

/* ---------- Stickers ---------- */
(function(){
  const root=$('#tab-stickers');
  root.innerHTML=`
    <h2>Stickers</h2>
    <div class="grid cols-3" id="stk-top">
      <div class="field" style="grid-column:1/-1">
        <label>Item description</label>
        <input id="desc-stk" placeholder="e.g., 2× Instagram Tag Stickers, white">
      </div>
    </div>
    <div class="grid cols-3" id="stk-form">
      <div class="field"><label>Quantity</label><input id="stk-qty" type="number" min="1" value="2"></div>
      <div class="field"><label>Unit Material Cost (£)</label><input id="stk-mat" type="number" step="0.01" value="0.50"></div>
      <div class="field"><label>Labour per unit (min)</label><input id="stk-min" type="number" step="0.1" value="1.5"></div>
      <div class="field"><label>Hourly rate (£/hr)</label><input id="stk-rate" type="number" step="0.01" value="12"></div>
      <div class="field"><label>Packaging per sticker (£)</label><input id="stk-pack" type="number" step="0.01" value="${cfg.default_packaging_per_unit||0}"></div>
      <div class="field"><label>Wastage %</label><input id="stk-waste" type="number" step="1" value="0"></div>
      <div class="field" style="grid-column:1/-1">
        <label>Material Quick Picks (Sam presets)</label>
        <select id="stk-material-pick">
          <option value="">-- select preset --</option>
          <option value="0.80">HTV — £0.80</option>
          <option value="0.50">Vinyl (Permanent) — £0.50</option>
          <option value="0.30">Vinyl (Other) — £0.30</option>
          <option value="0.15">Other Material — £0.15</option>
        </select>
        <small class="muted">Picking a preset overwrites Unit Material Cost.</small>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="primary" id="stk-calc">Calculate</button>
      <button id="stk-clear">Clear</button>
    </div>`;
  const out=resultPanel(root,'stk');

  const notesWrap=document.createElement('div');
  notesWrap.className='field';
  notesWrap.style.marginTop='16px';
  notesWrap.innerHTML=`<label>Notes</label><textarea id="notes-stk" placeholder="Deadlines, colours, customer requests…"></textarea>`;
  root.append(notesWrap);

  const id=x=>document.getElementById(x);
  $('#stk-material-pick').addEventListener('change',e=>{ if(e.target.value) id('stk-mat').value = e.target.value; });

  function calc(){
    const desc=id('desc-stk').value||'';
    const qty=+id('stk-qty').value||0;
    const mat=+(id('stk-mat').value||0);
    const minPer=+id('stk-min').value||0;
    const rate=+id('stk-rate').value||0;
    const packPer=+id('stk-pack').value||0;
    const waste=(+id('stk-waste').value||0)/100;

    const labourPer=(minPer/60)*rate;
    const matPer = mat*(1+waste);

    Calc.reset();
    Calc.add('Materials',qty,matPer);
    Calc.add('Labour',qty,labourPer);
    if (packPer>0) Calc.add('Packaging',qty,packPer);

    const t=totals(); out.set(t,Calc.lines,cfg.currency);

    window.lastQuote={
      category:'Stickers',
      description:desc,
      currency:cfg.currency,
      lines:[...Calc.lines],
      totals:t,
      notes:id('notes-stk').value||''
    };
  }
  $('#stk-calc').onclick=calc;
  $('#stk-clear').onclick=()=>{root.querySelectorAll('input,textarea').forEach(i=>i.value=''); out.clear()};
})();

/* ---------- Apparel (skeleton with existing pattern) ---------- */
(function(){
  const root=$('#tab-apparel');
  root.innerHTML=`
    <h2>Apparel</h2>
    <div class="grid cols-3">
      <div class="field" style="grid-column:1/-1">
        <label>Item description</label>
        <input id="desc-app" placeholder="e.g., 10× black tees with white chest logo (DTF)">
      </div>
    </div>
    <div class="grid cols-3" id="app-form">
      <div class="field"><label>Quantity</label><input id="app-qty" type="number" min="1" value="10"></div>
      <div class="field"><label>Blank garment cost (£)</label><input id="app-blank" type="number" step="0.01" value="3.50"></div>
      <div class="field"><label>Transfer/print cost per item (£)</label><input id="app-transfer" type="number" step="0.01" value="1.20"></div>
      <div class="field"><label>Press time per item (min)</label><input id="app-time" type="number" step="0.1" value="0.7"></div>
      <div class="field"><label>Labour rate (£/hr)</label><input id="app-rate" type="number" step="0.01" value="12"></div>
      <div class="field"><label>Setup time (min)</label><input id="app-setup" type="number" step="0.1" value="5"></div>
      <div class="field"><label>Packaging per item (£)</label><input id="app-pack" type="number" step="0.01" value="0.15"></div>
      <div class="field"><label>Wastage % (misprints)</label><input id="app-waste" type="number" step="1" value="3"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="primary" id="app-calc">Calculate</button>
      <button id="app-clear">Clear</button>
    </div>`;
  const out=resultPanel(root,'app');
  const id=x=>document.getElementById(x);
  function calc(){
    const desc=id('desc-app').value||'';
    const qty=+id('app-qty').value||0, blank=+id('app-blank').value||0, transfer=+id('app-transfer').value||0;
    const time=+id('app-time').value||0, rate=+id('app-rate').value||0, setup=+id('app-setup').value||0;
    const pack=+id('app-pack').value||0, waste=(+id('app-waste').value||0)/100;

    const matPer = blank + transfer + pack;
    const labourTotalHrs = (setup/60) + (time/60)*qty;
    const labourPer = labourTotalHrs>0 ? (labourTotalHrs*rate)/qty : 0;

    Calc.reset(); Calc.add('Materials',qty,matPer); Calc.add('Labour',qty,labourPer); if (waste>0) Calc.add('Wastage allowance', qty*waste, matPer);
    const t=totals(); out.set(t,Calc.lines,cfg.currency);

    window.lastQuote={ category:'Apparel', description:desc, currency:cfg.currency, lines:[...Calc.lines], totals:t, notes:'' };
  }
  $('#app-calc').onclick=calc; $('#app-clear').onclick=()=>{root.querySelectorAll('input').forEach(i=>i.value=''); out.clear()};
})();

/* ---------- Engraving ---------- */
(function(){
  const root=$('#tab-engraving');
  root.innerHTML=`
    <h2>Engraving</h2>
    <div class="grid cols-3">
      <div class="field" style="grid-column:1/-1">
        <label>Item description</label>
        <input id="desc-eng" placeholder="e.g., 5× anodized tags, logo engraving both sides">
      </div>
    </div>
    <div class="grid cols-3" id="eng-form">
      <div class="field"><label>Quantity</label><input id="eng-qty" type="number" min="1" value="5"></div>
      <div class="field"><label>Material cost per unit (£)</label><input id="eng-mat" type="number" step="0.01" value="1.00"></div>
      <div class="field"><label>Engrave time per unit (min)</label><input id="eng-time" type="number" step="0.1" value="3.0"></div>
      <div class="field"><label>Machine rate (£/hr)</label><input id="eng-rate" type="number" step="0.01" value="18"></div>
      <div class="field"><label>Setup time (min)</label><input id="eng-setup" type="number" step="0.1" value="4"></div>
      <div class="field"><label>Finishing time per unit (min)</label><input id="eng-finish" type="number" step="0.1" value="0.5"></div>
      <div class="field"><label>Operator labour (£/hr)</label><input id="eng-oprate" type="number" step="0.01" value="12"></div>
      <div class="field"><label>Packaging per unit (£)</label><input id="eng-pack" type="number" step="0.01" value="0.10"></div>
      <div class="field"><label>Wastage %</label><input id="eng-waste" type="number" step="1" value="2"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="primary" id="eng-calc">Calculate</button>
      <button id="eng-clear">Clear</button>
    </div>`;
  const out=resultPanel(root,'eng');

  const id=x=>document.getElementById(x);
  function calc(){
    const desc=id('desc-eng').value||'';
    const qty=+id('eng-qty').value||0, mat=+id('eng-mat').value||0, pack=+id('eng-pack').value||0, waste=(+id('eng-waste').value||0)/100;
    const tPer=+id('eng-time').value||0, rate=+id('eng-rate').value||0, setup=+id('eng-setup').value||0, finish=+id('eng-finish').value||0, opr=+id('eng-oprate').value||0;

    const machineHours = (setup/60) + (tPer/60)*qty;
    const machineCostTotal = machineHours * rate;
    const operatorHours = (finish/60)*qty;
    const operatorCostTotal = operatorHours * opr;

    const matPer = mat + pack;
    const labourPer = (machineCostTotal + operatorCostTotal)/Math.max(qty,1);

    Calc.reset(); Calc.add('Materials',qty,matPer); Calc.add('Labour',qty,labourPer); if (waste>0) Calc.add('Wastage allowance', qty*waste, matPer);
    const t=totals(); out.set(t,Calc.lines,cfg.currency);

    window.lastQuote={ category:'Engraving', description:desc, currency:cfg.currency, lines:[...Calc.lines], totals:t, notes:'' };
  }
  $('#eng-calc').onclick=calc; $('#eng-clear').onclick=()=>{root.querySelectorAll('input').forEach(i=>i.value=''); out.clear()};
})();

/* ---------- Homeware ---------- */
(function(){
  const root=$('#tab-homeware');
  root.innerHTML=`
    <h2>Homeware</h2>
    <div class="grid cols-3">
      <div class="field" style="grid-column:1/-1">
        <label>Item description</label>
        <input id="desc-hw" placeholder="e.g., 6× ceramic mugs, full-wrap print">
      </div>
    </div>
    <div class="grid cols-3" id="hw-form">
      <div class="field"><label>Quantity</label><input id="hw-qty" type="number" min="1" value="6"></div>
      <div class="field"><label>Blank cost per unit (£)</label><input id="hw-blank" type="number" step="0.01" value="2.10"></div>
      <div class="field"><label>Print/consumable per unit (£)</label><input id="hw-cons" type="number" step="0.01" value="0.80"></div>
      <div class="field"><label>Labour per unit (min)</label><input id="hw-min" type="number" step="0.1" value="1.2"></div>
      <div class="field"><label>Labour rate (£/hr)</label><input id="hw-rate" type="number" step="0.01" value="12"></div>
      <div class="field"><label>Packaging per unit (£)</label><input id="hw-pack" type="number" step="0.01" value="0.20"></div>
      <div class="field"><label>Setup time (min)</label><input id="hw-setup" type="number" step="0.1" value="3"></div>
      <div class="field"><label>Wastage %</label><input id="hw-waste" type="number" step="1" value="2"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="primary" id="hw-calc">Calculate</button>
      <button id="hw-clear">Clear</button>
    </div>`;
  const out=resultPanel(root,'hw');

  const id=x=>document.getElementById(x);
  function calc(){
    const desc=id('desc-hw').value||'';
    const qty=+id('hw-qty').value||0, blank=+id('hw-blank').value||0, cons=+id('hw-cons').value||0, pack=+id('hw-pack').value||0;
    const min=+id('hw-min').value||0, rate=+id('hw-rate').value||0, setup=+id('hw-setup').value||0, waste=(+id('hw-waste').value||0)/100;

    const matPer = blank + cons + pack;
    const labourTotal = ((setup/60) + (min/60)*qty)*rate;
    const labourPer = labourTotal/Math.max(qty,1);

    Calc.reset(); Calc.add('Materials',qty,matPer); Calc.add('Labour',qty,labourPer); if (waste>0) Calc.add('Wastage allowance', qty*waste, matPer);
    const t=totals(); out.set(t,Calc.lines,cfg.currency);

    window.lastQuote={ category:'Homeware', description:desc, currency:cfg.currency, lines:[...Calc.lines], totals:t, notes:'' };
  }
  $('#hw-calc').onclick=calc; $('#hw-clear').onclick=()=>{root.querySelectorAll('input').forEach(i=>i.value=''); out.clear()};
})();

/* ---------- Books ---------- */
(function(){
  const root=$('#tab-books');
  root.innerHTML=`
    <h2>Books</h2>
    <div class="grid cols-3">
      <div class="field" style="grid-column:1/-1">
        <label>Item description</label>
        <input id="desc-bk" placeholder="e.g., 20× A5 booklets, 40pp, colour cover">
      </div>
    </div>
    <div class="grid cols-3" id="bk-form">
      <div class="field"><label>Quantity</label><input id="bk-qty" type="number" min="1" value="20"></div>
      <div class="field"><label>Pages per book</label><input id="bk-pages" type="number" min="1" value="40"></div>
      <div class="field"><label>Print cost per page (£)</label><input id="bk-pp" type="number" step="0.001" value="0.05"></div>
      <div class="field"><label>Cover cost per book (£)</label><input id="bk-cover" type="number" step="0.01" value="0.60"></div>
      <div class="field"><label>Binding cost per book (£)</label><input id="bk-bind" type="number" step="0.01" value="0.40"></div>
      <div class="field"><label>Setup time (min)</label><input id="bk-setup" type="number" step="0.1" value="10"></div>
      <div class="field"><label>Labour per book (min)</label><input id="bk-min" type="number" step="0.1" value="1.5"></div>
      <div class="field"><label>Labour rate (£/hr)</label><input id="bk-rate" type="number" step="0.01" value="12"></div>
      <div class="field"><label>Wastage %</label><input id="bk-waste" type="number" step="1" value="2"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="primary" id="bk-calc">Calculate</button>
      <button id="bk-clear">Clear</button>
    </div>`;
  const out=resultPanel(root,'bk');

  const id=x=>document.getElementById(x);
  function calc(){
    const desc=id('desc-bk').value||'';
    const qty=+id('bk-qty').value||0, pages=+id('bk-pages').value||0, pp=+id('bk-pp').value||0;
    const cover=+id('bk-cover').value||0, bind=+id('bk-bind').value||0;
    const setup=+id('bk-setup').value||0, min=+id('bk-min').value||0, rate=+id('bk-rate').value||0, waste=(+id('bk-waste').value||0)/100;

    const matPer = pages*pp + cover + bind;
    const labourTotal = (setup/60)*rate + (min/60)*rate*qty;
    const labourPer = labourTotal/Math.max(qty,1);

    Calc.reset(); Calc.add('Materials',qty,matPer); Calc.add('Labour',qty,labourPer); if (waste>0) Calc.add('Wastage allowance', qty*waste, matPer);
    const t=totals(); out.set(t,Calc.lines,cfg.currency);

    window.lastQuote={ category:'Books', description:desc, currency:cfg.currency, lines:[...Calc.lines], totals:t, notes:'' };
  }
  $('#bk-calc').onclick=calc; $('#bk-clear').onclick=()=>{root.querySelectorAll('input').forEach(i=>i.value=''); out.clear()};
})();

/* ---------- LISTING TAB ---------- */
let listingBuilt=false;
function buildListingIfNeeded(){
  if (listingBuilt) return;
  const root=$('#tab-listing');
  root.innerHTML = `
    <h2>Create Listing</h2>
    <div class="grid cols-3" id="lst-form">
      <div class="field" style="grid-column:1/-1">
        <label>Title</label>
        <input id="lst-title" placeholder="Auto-filled from quote description">
      </div>

      <div class="field">
        <label>Pricing mode</label>
        <select id="lst-pr-mode">
          <option value="total" selected>Total price (quote total)</option>
          <option value="unit">Unit price (total ÷ qty)</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <div class="field">
        <label>Price</label>
        <input id="lst-price" type="number" step="0.01" placeholder="0.00">
      </div>

      <div class="field">
        <label>Rounding</label>
        <select id="lst-round">
          <option value="none" selected>No rounding</option>
          <option value="0.00">.00</option>
          <option value="0.49">.49</option>
          <option value="0.95">.95</option>
          <option value="0.99">.99</option>
        </select>
      </div>

      <div class="field">
        <label>Quantity</label>
        <input id="lst-qty" type="number" min="1" step="1" placeholder="Auto from quote">
      </div>

      <div class="field">
        <label>SKU (optional)</label>
        <input id="lst-sku" placeholder="PB-001">
      </div>

      <div class="field" style="grid-column:1/-1">
        <label>Tags (comma separated)</label>
        <input id="lst-tags" placeholder="sticker, vinyl, personalised, instagram, tag">
      </div>

      <div class="field" style="grid-column:1/-1">
        <label>Description</label>
        <textarea id="lst-desc" placeholder="Auto-built from quote breakdown, notes, and terms"></textarea>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="primary" id="lst-refresh">Refresh from quote</button>
      <button id="lst-copy-title">Copy Title</button>
      <button id="lst-copy-desc">Copy Description</button>
      <button id="lst-copy-all">Copy Full Listing</button>
    </div>
  `;
  const id = x => document.getElementById(x);
  const nf=(n,c)=>new Intl.NumberFormat('en-GB',{style:'currency',currency:c||cfg.currency||'GBP'}).format(Number(n)||0);

  function getQtyFromLines(lines){
    if (!Array.isArray(lines) || !lines.length) return 1;
    const q = Math.max(...lines.map(L => Number(L.qty)||0));
    return q>0? q : 1;
  }
  function applyRounding(val, mode){
    const num = Number(val)||0;
    if (mode==='none') return num;
    const pounds = Math.floor(num);
    const pence = Number(mode);
    return pounds + pence;
  }
  function buildDefaultTags(desc, category){
    const base = (desc||'').toLowerCase().split(/[^a-z0-9]+/).filter(Boolean);
    const uniq = Array.from(new Set([category, ...base])).filter(Boolean).slice(0,13);
    return uniq.join(', ');
  }
  function buildDescription(q){
    const cur = q.currency || cfg.currency || 'GBP';
    const lines = (q.lines||[]).map(L=>`• ${L.label}: ${L.qty} × ${nf(L.unit,cur)} = ${nf(L.cost,cur)}`).join('\n');
    const t=q.totals;
    const parts = [
      q.description || '(No title provided)',
      '',
      'Breakdown:',
      lines || '• (no lines)',
      '',
      `Subtotal: ${nf(t.subtotal,cur)}`,
      t.fees ? `Platform Fees: ${nf(t.fees,cur)}` : null,
      t.postage ? `Postage: ${nf(t.postage,cur)}` : null,
      t.margin ? `Margin: ${nf(t.margin,cur)}` : null,
      t.flat ? `Machine/Tools: ${nf(t.flat,cur)}` : null,
      `TOTAL: ${nf(t.grand,cur)}`,
      '',
      (window.lastQuote?.notes ? `Notes: ${window.lastQuote.notes}` : null),
      (cfg.payment_terms ? `\nTerms: ${cfg.payment_terms}` : null),
      [cfg.company_name,cfg.company_email,cfg.company_phone,cfg.company_address].filter(Boolean).join(' | ')
    ].filter(Boolean);
    return parts.join('\n');
  }
  function refreshFromQuote(){
    const q = window.lastQuote || {
      category: 'Listing',
      description: '',
      currency: cfg.currency,
      lines: [],
      totals: {subtotal:0,fees:0,postage:0,margin:0,flat:0,grand:0},
      notes:''
    };
    id('lst-title').value = q.description || `${q.category||'Item'} — Custom`;
    const qty = getQtyFromLines(q.lines);
    id('lst-qty').value = qty;
    const mode = id('lst-pr-mode').value;
    let price = 0;
    if (mode==='total') price = Number(q.totals?.grand)||0;
    else if (mode==='unit') price = qty ? (Number(q.totals?.grand)||0)/qty : 0;
    else price = Number(id('lst-price').value)||0;
    price = applyRounding(price, id('lst-round').value);
    id('lst-price').value = price.toFixed(2);
    if (!id('lst-tags').value) id('lst-tags').value = buildDefaultTags(q.description, q.category);
    id('lst-desc').value = buildDescription(q);
  }
  id('lst-refresh').onclick = refreshFromQuote;
  id('lst-pr-mode').onchange = refreshFromQuote;
  id('lst-round').onchange = refreshFromQuote;
  id('lst-copy-title').onclick = ()=>navigator.clipboard.writeText(id('lst-title').value).then(()=>alert('Title copied'));
  id('lst-copy-desc').onclick = ()=>navigator.clipboard.writeText(id('lst-desc').value).then(()=>alert('Description copied'));
  id('lst-copy-all').onclick = ()=>{
    const all = [
      `TITLE: ${id('lst-title').value}`,
      `PRICE: ${id('lst-price').value} ${cfg.currency||'GBP'}`,
      `QTY: ${id('lst-qty').value}`,
      id('lst-sku').value ? `SKU: ${id('lst-sku').value}` : null,
      id('lst-tags').value ? `TAGS: ${id('lst-tags').value}` : null,
      '',
      'DESCRIPTION:',
      id('lst-desc').value
    ].filter(Boolean).join('\n');
    navigator.clipboard.writeText(all).then(()=>alert('Full listing copied'));
  };
  listingBuilt=true;
}
function refreshListingFromQuote(){ if (listingBuilt) { document.getElementById('lst-refresh').click(); } }

/* ---------- Load tab from URL hash (optional) ---------- */
if (location.hash && panels[location.hash.slice(1)]) {
  document.querySelector(`nav.tabs button[data-tab="${location.hash.slice(1)}"]`)?.click();
}
</script>
</body>
</html>
